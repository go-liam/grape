# 代码测试

## 规范

-  单元测试代码文件必须以 _test.go 结尾
- 单元测试文件名 _test.go 前面的部分必须是被测方法所在文件的文件名
- 单元测试的函数名必须以 Test 开头，是可导出公开的函数
- 测试函数必须接收一个指向 testing.T 类型的指针，并且不能返回任何值

## mock

### 选型

https://github.com/golang/mock

### 理由

- golang 官方库
- 对比 https://github.com/stretchr/testify，不需要加入 mock.Mock （无源码入侵性），另外  

```shell script
testObj.On("DoSomething", 123).Return(true, nil)
```

   不会出现"DoSomething"字符串这种容易出错的调用
- EXPECT 简洁
```shell script
m.
EXPECT().
Bar(gomock.Eq(99)).
Return(101).
AnyTimes()
```
### 使用方法
https://github.com/golang/mock/tree/master/sample

## HTTP 请求
### 选型

https://golang.org/pkg/net/http/httptest/

### 理由

• golang 官方库，较 https://github.com/jarcoal/httpmock 有兼容保障
• 支持的东西与 net/http 一致，能最大限度模拟返回

### 使用方法
https://golang.org/src/net/http/httptest/example_test.go
参数校验
选型
表格驱动测试

``` 
func TestTime(t *testing.T) {
    testCases := []struct {  // 设计我们的测试用例
        gmt  string
        loc  string
        want string
    }{
        {"12:31", "Europe/Zuri", "13:31"},     // incorrect location name
        {"12:31", "America/New_York", "7:31"}, // should be 07:31
        {"08:08", "Australia/Sydney", "18:08"},
    }
    for _, tc := range testCases {  // 循环执行测试用例
        loc, err := time.LoadLocation(tc.loc)
        if err != nil {
            t.Fatalf("could not load location %q", tc.loc)
        }
        gmt, _ := time.Parse("15:04", tc.gmt)
        if got := gmt.In(loc).Format("15:04"); got != tc.want {
            t.Errorf("In(%s, %s) = %s; want %s", tc.gmt, tc.loc, got, tc.want)
        }
    }
}
```

### 理由

• 表格驱动测试方法让我们的测试方法更加清晰和简练，减少了复制粘贴，并大大提高的测试代码的可读性。
• VSCode 支持源代码一键生成表格驱动测试代码，我们只需要写 case，提高编写单元测试效率。Goland 的同学可以找下，应该也有支持的。
使用方法

## 数据库
选型
https://github.com/DATA-DOG/go-sqlmock
理由
• DATA-DOG 出品；2.4k starts；更新频率稳定；
• 兼容 gorm
• 支持  ExpectQuery 和 ExpectExec，前者主要用于模拟 SQL 的查询语句，后者用于模拟 SQL 的增删
使用方法
https://github.com/DATA-DOG/go-sqlmock/blob/master/examples/orders/orders_test.go

## 文件

### 选型

重构
### 理由

• 文件我们用的很少
• 有利于方法单一职责
• 无需 mock 和 临时文件

### 使用方法

https://endler.dev/2018/go-io-testing/

## Monkey

### 选型

https://github.com/bouk/monkey
### 理由

• github star 数最高的 monkey 库
### 使用方法

https://github.com/bouk/monkey#using-monkey

### 注意点

• 由于 monkey 它是在运行时替换了函数的指针来实现 mock，所以如果遇到一些简单的函数，例如 rand.Int63n 和 time.Now，编译器可能会直接将这种函数内联到调用实际发生的代码处并不会调用原有的方法，所以往往需要在测试时额外指定 -gcflags=-l 禁止编译器的内联优化（在 IDE 中跑单元测试的时候也记得加）。
• monkey 在一些面向安全的系统上是执行不成功的（不允许同时写入和执行内存页）。
• monkey 线程不安全
• monkey 项目已经Archived
鉴于 monkey 的这些注意点，我们需要注意的是不要在单元测试之外的地方使用 monkey，我们应该只在
上述的几种 mock 方法都不能满足需求时才使用 monkey（如：使用第三方库，并且第三方库没有提供 interface 时）。

## 参考
• https://shimo.im/docs/GKXvRHJpT8wpWtPC/read
• https://medium.com/@rosaniline/unit-testing-gorm-with-go-sqlmock-in-go-93cbce1f6b5b
• https://endler.dev/2018/go-io-testing/